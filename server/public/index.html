<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>RC Fleet Command Center</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #eee;
            margin: 0;
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 300px;
            background: #2d2d2d;
            padding: 20px;
            border-right: 1px solid #444;
        }

        #main {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: start;
        }

        h2 {
            margin-top: 0;
            color: #4caf50;
        }

        .car-item {
            background: #3d3d3d;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
        }

        .car-item:hover {
            background: #505050;
        }

        .car-item.active {
            border-left: 4px solid #4caf50;
            background: #383838;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }

        .online {
            background: #4caf50;
        }

        #video-container {
            width: 640px;
            height: 480px;
            background: #000;
            border: 2px solid #555;
            margin-bottom: 20px;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        #controls {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            gap: 10px;
        }

        button {
            padding: 15px;
            background: #444;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }

        button:active {
            background: #4caf50;
        }

        pre {
            background: #000;
            padding: 10px;
            width: 100%;
            height: 100px;
            overflow-y: scroll;
            font-size: 12px;
            font-family: monospace;
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <h2>üöú Vehicle Fleet</h2>
        <div id="car-list">
            <div class="car-item">
                <span>Scanning for vehicles...</span>
            </div>
        </div>

        <div style="margin-top: 50px;">
            <h3>System Log</h3>
            <pre id="log">Connecting to HQ...</pre>
        </div>
    </div>

    <div id="main">
        <h1>Remote Operation Console</h1>
        <div id="video-container">
            <!-- Video Canvas will be here -->
            <div style="position: absolute; top: 10px; left: 10px; color: yellow;">Live Feed: <span
                    id="current-car">None</span></div>
        </div>

        <div id="controls">
            <button></button>
            <button onclick="sendCommand('up')">‚¨ÜÔ∏è</button>
            <button></button>
            <button onclick="sendCommand('left')">‚¨ÖÔ∏è</button>
            <button onclick="sendCommand('down')">‚¨áÔ∏è</button>
            <button onclick="sendCommand('right')">‚û°Ô∏è</button>
        </div>
    </div>

    <script>
        // --- Frontend Agent Logic ---
        const ws = new WebSocket(`ws://${location.host}/ws`);
        const logEl = document.getElementById('log');

        // Simulate Video Player (Just a placeholder for now, normally use JSMpeg)
        // In real implementation, we would feed binary data to jsmpeg pipe.

        ws.onopen = () => {
            log('Connected to Relay Server.');
            // Authenticate
            ws.send(JSON.stringify({ type: 'auth', role: 'user' }));
        };

        ws.onmessage = async (event) => {
            const msg = event.data;

            // 1. Binary Video Data
            if (msg instanceof Blob) {
                // In a real app, feed this to JSMpeg player
                // console.log("Video frame received", msg.size);
                return;
            }

            // 2. JSON Control Data
            try {
                const json = JSON.parse(msg);
                if (json.type === 'car_list') {
                    renderCarList(json.data);
                }
            } catch (e) {
                log('Error parsing msg: ' + e);
            }
        };

        function renderCarList(list) {
            const container = document.getElementById('car-list');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<div style="padding:10px; color:#888;">No vehicles online</div>';
                return;
            }

            list.forEach(car => {
                const div = document.createElement('div');
                div.className = 'car-item';
                div.innerHTML = `
                <span>${car.id}</span>
                <div class="status-dot online"></div>
            `;
                div.onclick = () => selectCar(car.id);
                container.appendChild(div);
            });
        }

        let selectedCarId = null;

        function selectCar(id) {
            selectedCarId = id;
            document.getElementById('current-car').innerText = id;
            log(`Selected Control: ${id}`);
        }

        function sendCommand(dir) {
            if (!selectedCarId) {
                alert("Please select a vehicle from the list first!");
                return;
            }

            // Simple mapping for demo
            const payload = { lx: 0, ly: 0 };
            if (dir === 'up') payload.ly = 1;
            if (dir === 'down') payload.ly = -1;
            if (dir === 'left') payload.lx = -1;
            if (dir === 'right') payload.lx = 1;

            const cmd = {
                type: 'control',
                target_id: selectedCarId,
                payload: payload
            };
            ws.send(JSON.stringify(cmd));
            log(`Sent ${dir} to ${selectedCarId}`);
        }

        function log(txt) {
            logEl.textContent += `\n[${new Date().toLocaleTimeString()}] ${txt}`;
            logEl.scrollTop = logEl.scrollHeight;
        }
    </script>
</body>

</html>