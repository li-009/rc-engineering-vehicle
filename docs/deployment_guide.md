# 部署与性能优化指南 (Deployment & Optimization Guide)

本指南旨在确保云控平台实现 **"低延迟 (<200ms)"** 和 **"高流畅度 (25 FPS)"** 的核心目标。

## 1. 服务器选购标准 (Server Procurement)

### 1.1 核心指标：带宽 (Bandwidth) - **至关重要**
视频转发是带宽密集型业务。单路 QVGA MJPEG 视频流约需 **2 Mbps** 下行带宽。

*   **计费模式推荐**：**按使用流量计费 (Pay-By-Traffic)**
    *   不要购买固定带宽（如 5M/10M），价格贵且在多车并发时容易拥堵。
    *   **按流量计费**允许您将带宽峰值拉到 **100 Mbps**。不仅单车秒开，且能支持 30-50 台车同时并发，成本极低（约 0.8元/GB）。

### 1.2 地理位置 (Region)
*   **原则**：服务器必须物理距离车辆和控制端最近。
*   **示例**：
    *   车辆在**上海** -> 购买 **阿里云-杭州** 或 **腾讯云-上海**。
    *   车辆在**深圳** -> 购买 **华南-广州** 节点。
*   **目标**：将光纤传输延迟控制在 10ms 以内。

### 1.3 机器配置 (Instance Type)
Node.js 转发服务对 CPU 和内存要求极低。
*   **推荐配置**：**2核 2G** 或 **2核 4G** (突发性能实例即可)。
*   **系统**：Ubuntu 20.04 LTS 或 CentOS 7.9。

---

## 2. 车辆端性能优化 (Firmware Optimization)

### 2.1 分辨率设置 (Resolution)
为了保证操控手感，必须牺牲画质换取帧率。**严禁使用高清分辨率。**

| 分辨率 | 像素 | 预期帧率 | 延迟体验 | 结论 |
| :--- | :--- | :--- | :--- | :--- |
| **QVGA** | 320x240 | **25+ FPS** | **< 100ms** | **✅ 唯一推荐 (操控模式)** |
| VGA | 640x480 | 12 FPS | ~300ms | 仅用于静态观察 |
| SVGA | 800x600 | < 8 FPS | > 500ms | ❌ 不可用于遥控 |

### 2.2 核心参数建议 (Code Snippet)
在 ESP32 代码中强制应用以下设置：

```cpp
config.frame_size = FRAMESIZE_QVGA;  // 锁死 240P
config.jpeg_quality = 12;            // 10-15 之间，数字越小画质越好但体积越大
config.fb_count = 2;                 // 必须开启双缓冲 (需要 PSRAM)
```

## 3. 常见问题排查 (Troubleshooting)

*   **画面卡顿 (FPS < 10)**:
    1.  检查是否误开了 720P 或 UXGA 分辨率。
    2.  检查 ESP32 是否识别到了 PSRAM (`Serial Output: PSRAM found`).
    3.  检查是否在使用 HTTP 协议推流（请务必使用我们提供的 WebSocket 方案）。

*   **延迟大 (> 500ms)**:
    1.  服务器带宽是否跑满？（检查云控制台监控）
    2.  此时是否跨了南北网络（如 广州车 -> 北京服务器）？
